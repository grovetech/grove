I"3<p>It is true that not all migrations are equal and even truer that issues always arise during a migration that seem to be unique to our server setup that are outside of the general advice put forth by Apple in their knowledgeable articles. Moving the wiki server either to a different operating system or to a different computer is no exception. While I admire Apples attempt at making a Wiki and integrating it with their services, the product itself has been unsupported and buggy from the beginning.</p>

<p>Great for small teams but the issue is that wikis inherently encourage large team collaboration and so small teams ultimately grow to larger ones, and larger teams means larger storage sets and database sizes and when that happens event the best laid plans can turn into weeks of troubleshooting and hair pulling to try to make Apples migration techniques work.</p>

<p>So lets say thats where you are you have a wiki system you are trying to move, you used the method outlined <a href="https://support.apple.com/kb/ht5082" title="https://support.apple.com/kb/ht5082">here</a> and no dice. What do you do? Luckily starting in 10.7 Apple moved away from plist storage for their wiki and started using a PostgreSQL database. This is good news, because this means that its in a not easily corruptible format and is easy to extract. Not only that but its nearly tamperproof so accidentally deleting it is much harder than you think.</p>

<p>So how do I move my wiki, glad you asked. I recently helped out with a migration and I learned a few things in the process that surprised even me. The wiki migration steps outlined by Apple are 80% accurate. The method is to move the file storage (images, and attachments) and then export the database as a database dump.</p>

<p>Here is what worked for me.</p>

<p>On the source OS X server, perform this command in Terminal as an administrator in order to dump the Postgres database to a file:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>pg_dump <span class="nt">--format</span><span class="o">=</span>c <span class="nt">--compress</span><span class="o">=</span>9 <span class="nt">--blobs</span> <span class="nt">--username</span><span class="o">=</span>collab <span class="nt">--file</span><span class="o">=</span>/tmp/collab.pgdump collab</code></pre></figure>

<p>Copy /tmp/collab.pgdump from the source server to /tmp/collab.pgdump on the destination server, then copy the contents of /Library/Server/Wiki/FileData on the source server to /Library/Server/Wiki/FileData on the destination server.</p>

<p>Log in to the destination server as an administrator and execute the following commands in Terminal to ensure correct ownership and permissions, start the Postgres database, populate it with the data dumped from the source server, and finally start up the wiki service:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo chown</span> <span class="nt">-R</span> _teamsserver:_teamsserver /Library/Server/Wiki/FileData
<span class="nb">sudo chmod</span> <span class="nt">-R</span> +a <span class="s2">"www allow read"</span> /Library/Server/Wiki/FileData
<span class="nb">sudo </span>serveradmin stop wiki
<span class="nb">sudo </span>serveradmin start postgres
<span class="nb">sudo </span>rake <span class="nt">-f</span> /usr/share/collabd/server/Rakefile db:drop
<span class="nb">sudo </span>createuser <span class="nt">-U</span> _postgres <span class="nt">-d</span> <span class="nt">-s</span> collab
<span class="nb">sudo </span>createdb <span class="nt">-U</span> collab collab</code></pre></figure>

<p>Ok so far its pretty much the same well here is where it gets interesting. The database export on Apples page does not work well with large database sets. So to compensate you can dump the contents to a .sql file instead a dump file and get better results.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /usr/bin
./pg_dump <span class="nt">-U</span> _postgres collab <span class="nt">-c</span> <span class="nt">-f</span> /Library/Server/PostgreSQL/Backup/collab.sq</code></pre></figure>

<p>This exports the data, once done copy that sql file to the destination server or OS. To restore the sql file to another system do the following.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">psql <span class="nt">-U</span> _postgres <span class="nt">-d</span> collab <span class="nt">-f</span> /Path/To/The/SQL/File/collab.sql
<span class="nb">sudo </span>serveradmin start wiki</code></pre></figure>

<p>If you follow these steps in the order I have written them in, you should be good to go. There is just one major Gotcha. Lets say your moving to a new server and you are thinking of rebuilding your Open Directory. Keep in mind that the entire wiki system hard codes each article, user account, group account, images and more off of the GUID in the OD account.</p>

<p>This means that if you want your wiki to function you need to migrate over the OD in the Apple recommended way, or Export your Users and Groups to retain the GUID information. there is no way around this unfortunately. I hope this helps, alternatively if you are interested in a better wiki solution I have worked with the following free alternatives.</p>

<p><a href="https://buddypress.org" title="https://buddypress.org">BuddyPress</a>, <a href="https://openatrium.com" title="https://openatrium.com">Open Atrium,</a> and <a href="https://www.mediawiki.org/wiki/MediaWiki" title="https://www.mediawiki.org/wiki/MediaWiki">Media Wiki</a> are all good ones, for a good paid Wiki check out <a href="https://www.atlassian.com/software/confluence/overview/team-collaboration-software" title="https://www.atlassian.com/software/confluence/overview/team-collaboration-software">Confluence</a>.</p>

:ET