I"  <p>I was excited to see that Synology have recently integrated a PXE solution in their latest version of Diskstation Manager ‚Äì DSM 4.2 beta. This makes their NAS devices even more ideal in a home virtualisation lab as they are both cheap to buy and to run (the DS212 unit that I own consumes less than 20W in use), but also easy to configure and they offer a wide range of storage and network services such as CIFS / AFP / NFS / iSCSI, LDAP, PXE, TFTP, VPN, DNS.</p>

<p>They also offer more powerful Enterprise versions of their NAS devices, which run the same operating system but with much faster hardware. I‚Äôve yet to test them in a production environment, but given my experience in the lab, I am sure they would be a competitive solution.</p>

<p>In this post I will show you how to set up a PXE boot server that will let you perform a network installation of Centos 6.3 using your Synology NAS.</p>

<p><strong>What is PXE?</strong></p>

<p>PXE (pronounced pixie) stands for Preboot eXecution Environment. It‚Äôs a technology that can be used to boot a computer into an operating system from it‚Äôs network card without needing anything to be installed on the computer‚Äôs local storage devices in advance. Most modern servers come with PXE support as standard.</p>

<p>It‚Äôs incredibly useful if you wish to automate the deployment of many servers without having to attend each one with an installation CD / DVD / USB stick. With a little work, you can also configure custom kickstart files to be served to each server, to save having to enter all the installation options manually.</p>

<p>How to set up your Synology NAS as a PXE boot server</p>

<p><strong>Step 1 ‚Äì Install DSM 4.2</strong></p>

<p>Upgrade your Synology device to DSM 4.2 beta if you haven‚Äôt already. Follow the <a href="https://www.synology.com/support/beta_dsm4.2.php?lang=us">download links</a> for your region, download the appropriate firmware that for your model of device, then upload it in the DSM admin panel ‚Äì control panel ‚Äì DSM update screen.</p>

<p><strong>Step 2 ‚Äì Set up the DHCP Service on your NAS</strong></p>

<p>I would recommend you set up the DHCP server on your Synology first and test it works. If you are running this on your main LAN, you will need to disable the DHCP server on your router so they don‚Äôt conflict. You can download the DHCP server package in Package Center.</p>

<p>You will need to configure the relevant primary and secondary DNS, start and end IP addresses, netmask and gateway settings.</p>

<p>Once you are happy this is working, you can move on to configure the TFTP and PXE servers.</p>

<p><strong>Step 3 ‚Äì Set up the TFTP and PXE Services.</strong></p>

<p>Tick the Enable TFTP service box. You also need to specify a folder somewhere on your NAS that can be used as the TFTP root folder.</p>

<p>Tick the Enable PXE service box. In the boot loader box type pxelinux.0. Fill out the remaining fields using the same settings you used for DHCP in step 2. This will override the DHCP service settings.</p>

<p>This will set up a DHCP service which sets DHCP 67 (boot filename) in it‚Äôs DHCP offers to be PXELINUX.0. If the server making the DHCP request is performing a PXE boot, it will attempt to retrieve and load this file via TFTP from the DHCP server IP address. It is possible to tell the server to use a different server for TFTP using DHCP option 66 ‚Äì but this is not necessary in our case because the Synology NAS is performing both functions.</p>

<p><strong>Step 4 ‚Äì Upload the PXELINUX scripts and PXE menu to your tftp folder.</strong></p>

<p>In order to get PXE boot working, we now need to upload the PXELINUX.0 and a few associated files from the SYSLINUX project to the TFTP share. I‚Äôm sure you could use other boot loaders, but I have never tried any, so I‚Äôm going to stick to what I know!</p>

<p>According to the Centos wiki, the minimum required files to perform a PXE network boot using Clonezilla Live are:</p>

<p>pxelinux.0<br />
menu.c32<br />
memdisk<br />
mboot.c32<br />
chain.c32<br />
pxelinux.cfg/default<br />
path/to/your_kernel_of_choice<br />
path/to/your_init_ramdisk_of_choice<br />
vmlinuz<br />
initrd.img<br />
filesystem.squashfs</p>

<p><a href="https://clonezilla.org/downloads.php">Download Clonezilla live zip</a> file (You have to use Clonezilla live 1.2.0-25 or later), and unzip the required files (vmlinuz, initrd.img, and filesystem.squashfs in dir live) to /tftpboot/nbi_img/. You can make it by something like: ‚Äúunzip -j clonezilla-live-*.zip live/vmlinuz live/initrd.img live/filesystem.squashfs -d /tftpboot/nbi_img/‚Äù (Replace clonezilla-live-*.zip with the file name you just downloaded).</p>

<p>To make things easier I have forked a GitHub repo that was created to get PXE Boot of a CentOS Install started but modified it for Clonezilla Live.</p>

<p><a class="btn d-block w-100 btn-default btn-lg" href="https://github.com/jonbrown21/TFTP-PXE-Boot-Server"><i class="icon-github"></i> TFTP PXE Boot Server Repo </a></p>

<p>Edit your PXElinux config file /tftpboot/nbi_img/pxelinux.cfg/default, and append the following</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">label Clonezilla-live
MENU LABEL Clonezilla Live <span class="o">(</span>Ramdisk<span class="o">)</span>
KERNEL vmlinuz
APPEND <span class="nv">initrd</span><span class="o">=</span>initrd.img <span class="nv">boot</span><span class="o">=</span>live config noswap nolocales <span class="nv">edd</span><span class="o">=</span>on nomodeset <span class="nv">ocs_live_run</span><span class="o">=</span><span class="s2">"ocs-live-general"</span> <span class="nv">ocs_live_extra_param</span><span class="o">=</span><span class="s2">""</span> keyboard-layouts<span class="o">=</span><span class="s2">""</span> <span class="nv">ocs_live_batch</span><span class="o">=</span><span class="s2">"no"</span> <span class="nv">locales</span><span class="o">=</span><span class="s2">""</span> <span class="nv">vga</span><span class="o">=</span>788 nosplash noprompt <span class="nv">fetch</span><span class="o">=</span>tftp://<span class="nv">$serverIP</span>/filesystem.squashfs</code></pre></figure>

<p><strong>Note</strong></p>

<ol>
  <li>Replace $serverIP with your IP address of tftp (DRBL) server.</li>
  <li>Remember to check kernel, initrd file names and boot parameters in syslinux/syslinux.cfg from the zip file, copy them to here. It might be different from here, say vmlinuz path maybe different.</li>
  <li>Here we do not put ‚Äúip=frommedia‚Äù in the boot parameters because the /etc/resolv.conf get in live-initramfs won‚Äôt exist in the system after initramfs is done.</li>
  <li>‚Äúfetch‚Äù also supports http or ftp, if you want to use http or ftp instead of tftp, you have to put the file filesystem.squashfs in your http or ftp server and the corresponding path.</li>
  <li>If you want to do unattended clone, you can assign clonezilla live parameters (ocs_live_run, ocs_live_extra_param, ocs_live_keymap, ocs_live_batch and ocs_lang) in kernel parameters. For example, you can use:</li>
</ol>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">append <span class="nv">initrd</span><span class="o">=</span>initrd.img <span class="nv">boot</span><span class="o">=</span>live <span class="nv">union</span><span class="o">=</span>aufs noswap noprompt <span class="nv">vga</span><span class="o">=</span>788 keyboard-layouts<span class="o">=</span>NONE <span class="nv">locales</span><span class="o">=</span>en_US.UTF-8 <span class="nv">fetch</span><span class="o">=</span>tftp://<span class="nv">$serverIP</span>/filesystem.squashfs</code></pre></figure>

<p><strong>Step 5 ‚Äì Attempt to PXE boot a server.</strong></p>

<p>All you need now is a server. Ensure the server is connected to the LAN with your Synology NAS on it, then power on the server and instruct it to perform a network boot. It should make a DHCP request to the NAS, and then perform a PXE boot using the files that we copied to the TFTP server.</p>

<p>If you want to load a different operating system, you need to copy across the relevant kernels / initial ramdisks for the distribution of your choice and then edit the PXE menu in pxelinux.cfg/default. You may also wish to either remove the kickstart parameter, or refer to a different kickstart of your own creation.</p>

:ET