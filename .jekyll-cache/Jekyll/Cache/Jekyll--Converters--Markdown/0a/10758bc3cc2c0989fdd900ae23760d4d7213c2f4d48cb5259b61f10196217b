I"Ù:<p>OSX Server comes pre-packaged with Dovecot one of the best IMAP services out there and one of the most extensible and flexible in my opinion. That is its flexible and extensible as long as you know how to configure Dovecot which most OSX Server Administrators are not. I had a conversation with a co-worker not too long ago about being an OSX Server Administrator and I joked that Apple made great hardware and a great OS but most if not all of the services under the hood for Web, Mail, Mailing Lists, etcâ€¦ were all borrowed open source technologies and that Apple really does not offer any sort of support base for the open source technologies that they use. However without these pieces of software their entire PR Campaign would hold no water. What I praise Apple for is taking these tools and utilizing them and making them easier to use while leaving the ability to tinker and improve these services.</p>

<p>One such service is the topic today, Dovecot. Dovecot is integrated with Server Admin, Apples GUI Server Administration tool. You can set two different kind of notifications to trigger here, a quota notification that will send an email out when someone is over a certain percentage of email quota and an email warning them when they have gone over quota. In my experience it takes more than a couple emails to make a user clean up their inbox.</p>

<p>What I wanted was a way to say, send out an email when a user goes over a specified limit and then send an email every ten percent they go over the original limit. When they reach ten percent before their quota is exceeded increase the email notification rate to one email every percent until they reach their quota and then at that time continue to send an email a day until their quota has been reduced. On top of that I wanted it to also notify me of people who have gone over quota so that I can prove to them that they did indeed get the notification. For me a good solution was having all quota notifications CCâ€™d to our help desk which in turn opened a ticket on the behalf of the offender in a sense sending them two emails each time they went over quota. I am going to cover the necessary steps needed to accomplish this task on your OSX Mail server.</p>

<p>** Note what we are about to do will mean that you will no longer be able to use Server Admin to manage email notifications.</p>

<h4 id="1-locate-the-dovecot-configuration-file">1. Locate the Dovecot Configuration file.</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /etc/dovecot/dovecot.conf</code></pre></figure>

<h4 id="2-edit-the-file">2. Edit the file</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>pico /etc/dovecot/dovecot.conf</code></pre></figure>

<h4 id="3-find-this-line">3. Find this line</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">quota_warning <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>100%% /usr/libexec/dovecot/quota-exceeded.sh</code></pre></figure>

<p>we are going to modify this line and add the following lines.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">quota_warning <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>100%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning2 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>99%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning3 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>98%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning4 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>97%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning5 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>96%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning6 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>95%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning7 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>94%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning8 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>93%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning9 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>92%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning10 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>91%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning11 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>90%% /usr/libexec/dovecot/quota-exceeded.sh
  quota_warning12 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>87%% /usr/libexec/dovecot/quota-warning.sh
  quota_warning13 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>85%% /usr/libexec/dovecot/quota-warning.sh
  quota_warning14 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>80%% /usr/libexec/dovecot/quota-warning.sh
  quota_warning15 <span class="o">=</span> <span class="nv">storage</span><span class="o">=</span>75%% /usr/libexec/dovecot/quota-warning.sh</code></pre></figure>

<p>What we are saying here is that we are going to send out an email every time someone is over their limit. Here the limit is 75% and every 5% they go over they will get another warning until they get to 90% then the warnings become more frequent one every 1%. Not only that but there are two different messages the quota-warning and the quota-exceeded.</p>

<h4 id="4-we-are-going-to-create-a-new-quota-warningsh-file">4. We are going to create a new quota-warning.sh file</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /usr/libexec/dovecot
<span class="nb">sudo </span>pico quota-warning.sh</code></pre></figure>

<p>This is the current default Apple script that triggers the default email created in Server Admin.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/sh</span>

<span class="nv">_quota_txt</span><span class="o">=</span>/etc/mail/quota_warning.txt

<span class="k">if</span> <span class="o">[</span> <span class="nt">-e</span> <span class="nv">$_quota_txt</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">cat</span> <span class="nv">$_quota_txt</span> | /usr/libexec/dovecot/deliver <span class="nt">-d</span> <span class="nv">$USER</span>
<span class="k">fi</span></code></pre></figure>

<p>We are going to modify this script to send out an email of our choice and to do so to another recipient so we have a record of users getting notifications.Here is the script that I wrote that does just that.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="nv">PERCENT</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">FROM_SMTP</span><span class="o">=</span><span class="s2">"support@somedomain.com"</span>
<span class="nv">FROM</span><span class="o">=</span><span class="s2">"FWW Support &lt;support@somedomain.com&gt;"</span>
<span class="nv">TO</span><span class="o">=</span><span class="s2">"FWW Support &lt;mail-server-admini@somedomain.com&gt;"</span>
<span class="nv">qwf</span><span class="o">=</span><span class="s2">"/tmp/quota.warning.</span><span class="nv">$$</span><span class="s2">"</span>

<span class="nb">echo</span> <span class="s2">"From: </span><span class="nv">$FROM</span><span class="s2">
To: </span><span class="nv">$USER</span><span class="s2">
Subject: Quota Notification
Content-Type: text/plain; charset="</span>UTF-8<span class="s2">"

Hello-
This is a warning email that was automatically sent. You are nearing your quota limit. The current quota is 1 GB of storage space per user. However you can store more offline.
Q: What can I do now?
A: Start backing up your emails and storing them in a folder under the On My Mac heading, this will ensure that your emails will still be stored and it will free up space on your online account.

If you need more assistance please contact Jon Brown at 
support@somedomain.com.
Thank you for your cooperation!
-- Some Organization Mail Server"</span> <span class="o">&gt;</span> <span class="nv">$qwf</span>

<span class="nb">cat</span> <span class="nv">$qwf</span> | /usr/sbin/sendmail <span class="nt">-f</span> <span class="nv">$FROM_SMTP</span> <span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span>
<span class="nb">rm</span> <span class="nt">-f</span> <span class="nv">$qwf</span>

<span class="nb">echo</span> <span class="s2">"From: </span><span class="nv">$USER</span><span class="s2">
To: support@somedomain.com
Subject: Quota Notification
Content-Type: text/plain; charset="</span>UTF-8<span class="s2">"

Hello  -

</span><span class="nv">$USER</span><span class="s2"> Is nearing their quota. Please follow these steps.
1. Call the user and make sure they understand how to archive their email.
2. Explain to the user that they can sort their email by largest size, tell them to discard or remove the largest emails first.
3. Ensure that the quota has been reduced in Server Admin, do not increase the quota unless it is an emergency.
-- Some Organization Mail Server"</span> <span class="o">&gt;</span> <span class="nv">$qwf</span>

<span class="nb">cat</span> <span class="nv">$qwf</span> | /usr/sbin/sendmail <span class="nt">-f</span> <span class="nv">$FROM_SMTP</span> <span class="s2">"support@somedomain.com"</span>
<span class="nb">rm</span> <span class="nt">-f</span> <span class="nv">$qwf</span>
<span class="nb">exit </span>0</code></pre></figure>

<p>You must replace the above script with the old script entirely. This will negate the ability to use the text file that Server Admin uses for email notifications but allows you to send the notification to multiple people.</p>

<h4 id="4-we-are-going-to-create-a-new-quota-exceededsh-file">4. We are going to create a new quota-exceeded.sh file</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /usr/libexec/dovecot
<span class="nb">sudo </span>pico quota-warning.sh</code></pre></figure>

<p>This is the current default Apple script that triggers the default email created in Server Admin.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/sh</span>
<span class="nv">_quota_txt</span><span class="o">=</span>/etc/mail/quota_exceeded.txt
<span class="k">if</span> <span class="o">[</span> <span class="nt">-e</span> <span class="nv">$_quota_txt</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">cat</span> <span class="nv">$_quota_txt</span> | /usr/libexec/dovecot/deliver <span class="nt">-d</span> <span class="nv">$USER</span>
<span class="k">fi</span></code></pre></figure>

<p>We are going to re-write this script and use the following to do similar to the above but at a more aggressive rate.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nv">PERCENT</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">FROM_SMTP</span><span class="o">=</span><span class="s2">"support@somedomain.com"</span>
<span class="nv">FROM</span><span class="o">=</span><span class="s2">"FWW Support &lt;support@somedomain.com&gt;"</span>
<span class="nv">TO</span><span class="o">=</span><span class="s2">"FWW Support &lt;mail-server-admin@somedomain.com&gt;"</span>
<span class="nv">qwf</span><span class="o">=</span><span class="s2">"/tmp/quota.warning.</span><span class="nv">$$</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"From: </span><span class="nv">$FROM</span><span class="s2">
To: </span><span class="nv">$USER</span><span class="s2">
Subject: FWW ***You're Over Your Quota***
Content-Type: text/plain; charset="</span>UTF-8<span class="s2">"
Hello-
This is a warning email that was automatically sent. You are nearing your quota limit. The current quota is 1 GB of storage space per user. However you can store more offline.
Q: What can I do now?
A: Start backing up your emails and storing them in a folder under the On My Mac heading, this will ensure that your emails will still be stored and it will free up space on your online account.
If you need more assistance please contact Jon Brown at support@somedomain.com.
Thank you for your cooperation!
-- Mac Server"</span> <span class="o">&gt;</span> <span class="nv">$qwf</span>

<span class="nb">cat</span> <span class="nv">$qwf</span> | /usr/sbin/sendmail <span class="nt">-f</span> <span class="nv">$FROM_SMTP</span> <span class="s2">"</span><span class="nv">$USER</span><span class="s2">"</span>
<span class="nb">rm</span> <span class="nt">-f</span> <span class="nv">$qwf</span>

<span class="nb">echo</span> <span class="s2">"From: </span><span class="nv">$USER</span><span class="s2">
To: support@somedomain.com
Subject: FWW ***You're Over Your Quota***
Content-Type: text/plain; charset="</span>UTF-8<span class="s2">"

Hello  -
</span><span class="nv">$USER</span><span class="s2"> Is nearing their quota. Please follow these steps.
1. Call the user and make sure they understand how to archive their email.
2. Explain to the user that they can sort their email by largest size, tell them to discard or remove the largest emails first.
3. Ensure that the quota has been reduced in Server Admin, do not increase the quota unless it is an emergency.
4. Explain to the user that their email will stop working if they reach 99% capacity.
-- Mac Server"</span> <span class="o">&gt;</span> <span class="nv">$qwf</span>
<span class="nb">cat</span> <span class="nv">$qwf</span> | /usr/sbin/sendmail <span class="nt">-f</span> <span class="nv">$FROM_SMTP</span> <span class="s2">"support@somedomain.com"</span>
<span class="nb">rm</span> <span class="nt">-f</span> <span class="nv">$qwf</span>
<span class="nb">exit </span>0</code></pre></figure>

<p>That is it, once you are done you must restart dovecot.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>serveradmin stop mail
<span class="nb">sudo </span>serveradmin start mail</code></pre></figure>

<p>Once done you will now be able to enjoy the fruits of your labor. Your users will now get a lot more notifications which will mean that they will be more likely to tame their unruly inboxes on their own and you will be notified as to when they are getting notifications so that you can better assist them with this task. As always I encourage your comments, suggestions and questions. I hope you all enjoyed my post and thanks for reading!</p>

:ET